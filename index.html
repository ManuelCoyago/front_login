<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel de Acceso</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- Formulario de Login -->
<form id="loginForm">
  <h2>Iniciar Sesi√≥n</h2>
  <input type="text" id="email" placeholder="Correo electr√≥nico" required />
  <input type="password" id="password" placeholder="Contrase√±a" required />
  <button type="submit" class="btn-primary">Ingresar</button>
  <div id="message" class="message"></div>
</form>

<div id="2fa-section" class="hidden">
  <h3>Autenticaci√≥n en Dos Pasos</h3>
  <div id="qr-container"></div>
  <input type="text" id="totp-code" placeholder="C√≥digo de 6 d√≠gitos">
  <button id="verify-2fa-btn">Verificar</button>
</div>

<!-- Secci√≥n de Productos -->
<div id="productosPanel" class="productos hidden">
  <h2>Productos Disponibles</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripci√≥n</th>
        <th>Precio</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="productosBody"></tbody>
  </table>
</div>

<!-- Secci√≥n de CRUD Productos (para adminP) -->
<div id="crudProductos" class="panel hidden">
  <h2>Administrar Productos</h2>
  <form id="productoForm">
    <input type="hidden" id="productoId" value="">
    <input type="text" id="nombreProducto" placeholder="Nombre" required />
    <input type="text" id="descripcionProducto" placeholder="Descripci√≥n" />
    <input type="number" id="precioProducto" placeholder="Precio" step="0.01" required />
    <div class="button-group">
      <button type="submit" id="productoSubmitBtn" class="btn-primary">Crear Producto</button>
      <button type="button" id="cancelarEdicionProducto" class="btn-delete hidden">Cancelar</button>
    </div>
  </form>
</div>
<!-- Secci√≥n de Usuarios -->
<div id="usuariosPanel" class="usuarios hidden">
  <h2>Usuarios Registrados</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Rol</th>
        <th class="actions-header">Acciones</th>
      </tr>
    </thead>
    <tbody id="usuariosBody"></tbody>
  </table>
</div>

<!-- Secci√≥n de CRUD Usuarios (para admin) -->
<div id="crudUsuarios" class="panel hidden">
  <h2>Administrar Usuarios</h2>
  <form id="usuarioForm">
    <input type="hidden" id="usuarioId" value="">
    <input type="text" id="usernameUsuario" placeholder="Username" required />
    <input type="text" id="correoUsuario" placeholder="Correo electr√≥nico" required />
    <input type="password" id="claveUsuario" placeholder="Contrase√±a" required />
    
    <div class="form-group">
      <label for="rolUsuario">Rol:</label>
      <select id="rolUsuario" required>
        <option value="">Seleccione un rol</option>
        <option value="admin">Administrador</option>
        <option value="adminP">Admin Productos</option>
        <option value="user">Usuario Normal</option>
      </select>
    </div>
    
    <div class="button-group">
      <button type="submit" id="usuarioSubmitBtn" class="btn-primary">Crear Usuario</button>
      <button type="button" id="cancelarEdicionUsuario" class="btn-delete hidden">Cancelar</button>
    </div>
  </form>
</div>

<script src="productos.js"></script>
<script src="usuarios.js"></script>

<script>
// Variables globales compartidas
let authToken = '';
let userRole = '';
let tempLoginData = null; // Para guardar datos de login si requiere 2FA

const loginForm = document.getElementById('loginForm');
const productosPanel = document.getElementById('productosPanel');
const usuariosPanel = document.getElementById('usuariosPanel');
const crudProductos = document.getElementById('crudProductos');
const crudUsuarios = document.getElementById('crudUsuarios');
const messageEl = document.getElementById('message');

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  // Limpiar mensajes y UI
  messageEl.textContent = '';
  messageEl.className = 'message';
  productosPanel.classList.add('hidden');
  crudProductos.classList.add('hidden');
  crudUsuarios.classList.add('hidden');
  usuariosPanel.classList.add('hidden');
  
  // Mostrar loader
  messageEl.innerHTML = '<div class="loader"></div>';

  try {
    const res = await fetch('http://localhost:5002/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email, password})
    });

    const data = await res.json();

    if (res.ok) {
      // Login exitoso
      messageEl.textContent = data.message || 'Inicio de sesi√≥n exitoso';
      messageEl.className = 'message success';
      
      authToken = data.token || '';
      userRole = data.role || '';

      if (data.requires_2fa) {
        tempLoginData = data; // Guarda los datos del login temporalmente
        loginForm.classList.add('hidden'); // Oculta el formulario de login
        setup2FA(data.email);
        return; // Detiene la ejecuci√≥n hasta que se verifique 2FA
      }
      
      // Ocultar mensaje despu√©s de 2 segundos
      setTimeout(() => {
        messageEl.textContent = '';
        messageEl.className = 'message';
      }, 2000);

      // Mostrar secciones seg√∫n rol
      if (data.products && Array.isArray(data.products) && userRole !== 'admin') {
        renderProductos(data.products);
        productosPanel.classList.remove('hidden');
      }
      
      if (userRole === 'admin') {
        cargarUsuarios();
        usuariosPanel.classList.remove('hidden');
        crudUsuarios.classList.remove('hidden');
      } else if (userRole === 'adminP') {
        cargarProductos();
        crudProductos.classList.remove('hidden');
      } else {
        // Usuario normal solo ve productos
        if (data.products && Array.isArray(data.products)) {
          renderProductos(data.products);
          productosPanel.classList.remove('hidden');
        }
      }

    } else {
      // Credenciales incorrectas
      messageEl.textContent = data.message || 'Credenciales incorrectas. Por favor intenta nuevamente.';
      messageEl.className = 'message error';
      
      // Limpiar campo de contrase√±a
      document.getElementById('password').value = '';
      
      // Enfocar el campo de email
      document.getElementById('email').focus();
    }
  } catch (err) {
    console.error(err);
    messageEl.textContent = 'Error de conexi√≥n con el servidor. Intente nuevamente.';
    messageEl.className = 'message error';
  }
});

async function setup2FA(email) {
  const yaConfigurado = localStorage.getItem(`2fa_configurado_${email}`);
  const secretGuardado = localStorage.getItem(`2fa_secret_${email}`);

  if (!yaConfigurado) {
    // Generar nuevo secreto y QR
    const response = await fetch('http://localhost:5004/generate-2fa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const { secret, qr_code } = await response.json();

    // Guardar temporalmente el secreto (para verificaci√≥n)
    localStorage.setItem('temp_2fa_secret', secret);

    // Mostrar QR
    document.getElementById('qr-container').innerHTML = `
      <p>Escanee con Google Authenticator:</p>
      <img src="${qr_code}" alt="QR Code" style="width:200px;height:200px;">
      <p>O ingrese manualmente: <strong>${secret}</strong></p>
    `;
  } else {
    // Ya configurado ‚Üí no mostrar QR
    document.getElementById('qr-container').innerHTML = '';
    localStorage.removeItem('temp_2fa_secret');
  }

  // Mostrar campo de c√≥digo
  document.getElementById('2fa-section').classList.remove('hidden');
  document.getElementById('totp-code').value = '';
}

document.getElementById('verify-2fa-btn').addEventListener('click', async () => {
  const code = document.getElementById('totp-code').value;
  const email = tempLoginData.email;

  const secret = localStorage.getItem('temp_2fa_secret') || localStorage.getItem(`2fa_secret_${email}`);

  if (!secret) {
    alert('No se encontr√≥ el secreto para verificar. Intenta escanear el QR nuevamente.');
    return;
  }

  const response = await fetch('http://localhost:5004/verify-2fa', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ secret, token: code })
  });

  const { valid } = await response.json();

  if (valid) {
    // Guardar secreto permanentemente en localStorage (simulado)
    if (localStorage.getItem('temp_2fa_secret')) {
      localStorage.setItem(`2fa_secret_${email}`, secret);
    }

    // Marcar como configurado
    localStorage.setItem(`2fa_configurado_${email}`, 'true');
    
    localStorage.removeItem('temp_2fa_secret');
    await save2FASecret(secret); // opcional
    completeLogin();
  } else {
    alert('C√≥digo inv√°lido');
    document.getElementById('totp-code').value = '';
  }
});



// Simulaci√≥n de guardar el secreto en el backend (puedes implementar seg√∫n tu API)
async function save2FASecret(secret) {
  // Aqu√≠ podr√≠as hacer un fetch a tu backend para guardar el secreto asociado al usuario
  // Por ahora es solo un placeholder
  return true;
}

function completeLogin() {
  document.getElementById('2fa-section').classList.add('hidden');
  messageEl.textContent = '2FA verificado. Accediendo...';
  messageEl.className = 'message success';

  if (tempLoginData) {
    authToken = tempLoginData.token || '';
    userRole = tempLoginData.role || '';

    // Mostrar secciones seg√∫n rol
    if (userRole === 'admin') {
      cargarUsuarios();
      usuariosPanel.classList.remove('hidden');
      crudUsuarios.classList.remove('hidden');
    } else if (userRole === 'adminP') {
      cargarProductos();
      productosPanel.classList.remove('hidden');   // üëà ESTO FALTABA
      crudProductos.classList.remove('hidden');
    } else {
      if (tempLoginData.products && Array.isArray(tempLoginData.products)) {
        renderProductos(tempLoginData.products);
        productosPanel.classList.remove('hidden');
      }
    }

    tempLoginData = null; // Limpia los datos temporales
  }
}

</script>
</body>
</html>